<!DOCTYPE html>
<html lang="fr">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1" />
    <title>G√©n√©rateur de mot de passe s√©curis√©</title>
    <style>
      :root {
        --bg-light: #f0f0f0;
        --text-light: #333;
        --bg-dark: #141414;
        --text-dark: #eee;
        --accent: #4caf50;
        --accent-soft: rgba(76, 175, 80, 0.15);
        --header-bg-light: #ffffff;
        --header-bg-dark: #1f1f1f;
        --footer-bg-light: #ffffff;
        --footer-bg-dark: #1f1f1f;
        --card-bg-light: rgba(255, 255, 255, 0.9);
        --card-bg-dark: rgba(0, 0, 0, 0.6);
        --border-light: #ddd;
        --border-dark: #444;
        --strength-weak: #e74c3c;
        --strength-medium: #f1c40f;
        --strength-strong: #2ecc71;
        --strength-very-strong: #0a7a3b;
      }

      * {
        box-sizing: border-box;
      }

      body {
        margin: 0;
        font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
          Arial, sans-serif;
        background-color: var(--bg-light);
        color: var(--text-light);
        transition: background-color 0.3s, color 0.3s;
      }

      body.dark {
        background-color: var(--bg-dark);
        color: var(--text-dark);
      }

      .app {
        min-height: 100vh;
        display: flex;
        flex-direction: column;
      }

      header {
        position: sticky;
        top: 0;
        z-index: 10;
        background-color: var(--header-bg-light);
        border-bottom: 1px solid var(--border-light);
        backdrop-filter: blur(6px);
      }

      body.dark header {
        background-color: var(--header-bg-dark);
        border-bottom-color: var(--border-dark);
      }

      .header-inner {
        max-width: 960px;
        margin: 0 auto;
        padding: 0.75rem 1rem;
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 1rem;
      }

      .brand {
        display: flex;
        flex-direction: column;
        gap: 0.15rem;
      }

      .brand-title {
        font-weight: 700;
        font-size: 1.1rem;
      }

      .brand-subtitle {
        font-size: 0.8rem;
        opacity: 0.75;
      }

      nav {
        display: flex;
        gap: 0.5rem;
        align-items: center;
      }

      .nav-link {
        border: none;
        background: transparent;
        padding: 0.35rem 0.75rem;
        border-radius: 999px;
        font-size: 0.9rem;
        cursor: pointer;
        color: inherit;
        opacity: 0.8;
        transition: background-color 0.15s, opacity 0.15s, transform 0.05s;
      }

      .nav-link:hover {
        opacity: 1;
        background-color: rgba(0, 0, 0, 0.04);
      }

      body.dark .nav-link:hover {
        background-color: rgba(255, 255, 255, 0.06);
      }

      .nav-link--active {
        opacity: 1;
        background-color: var(--accent-soft);
        transform: translateY(-1px);
      }

      .theme-toggle-btn {
        border-radius: 999px;
        border: 1px solid var(--border-light);
        padding: 0.35rem 0.75rem;
        background: transparent;
        cursor: pointer;
        font-size: 0.85rem;
      }

      body.dark .theme-toggle-btn {
        border-color: var(--border-dark);
      }

      main {
        flex: 1;
        max-width: 960px;
        width: 100%;
        margin: 0 auto;
        padding: 1.5rem 1rem 2rem;
      }

      .section {
        display: none;
      }

      .section.section--active {
        display: block;
      }

      .section-title {
        font-size: 1.4rem;
        font-weight: 600;
        margin-bottom: 1rem;
      }

      .card {
        background-color: var(--card-bg-light);
        padding: 1.5rem;
        border-radius: 0.9rem;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        border: 1px solid rgba(0, 0, 0, 0.03);
      }

      body.dark .card {
        background-color: var(--card-bg-dark);
        border-color: rgba(255, 255, 255, 0.04);
      }

      .generator-card {
        max-width: 480px;
        margin: 0 auto;
      }

      .controls {
        display: grid;
        gap: 0.75rem;
      }

      .controls label {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        font-size: 0.9rem;
      }

      .controls .char-option {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 0.5rem;
        font-size: 0.9rem;
      }

      .controls .char-option .min-input-group {
        display: flex;
        align-items: center;
        gap: 0.25rem;
      }

      .controls .char-option input[type="number"] {
        width: 60px;
        text-align: center;
        padding-inline: 0.25rem;
      }

      select,
      input[type="text"],
      input[type="number"] {
        width: 100%;
        padding: 0.45rem 0.6rem;
        font-size: 0.9rem;
        border-radius: 0.5rem;
        border: 1px solid #ccc;
        background-color: #fff;
        color: inherit;
      }

      body.dark select,
      body.dark input[type="text"],
      body.dark input[type="number"] {
        background: #444;
        border-color: #555;
        color: var(--text-dark);
      }

      button {
        cursor: pointer;
        border: none;
        border-radius: 0.5rem;
        font-size: 0.9rem;
      }

      .btn-primary {
        background: var(--accent);
        color: #fff;
        padding: 0.6rem 0.9rem;
        width: 100%;
      }

      .btn-primary:hover {
        opacity: 0.95;
      }

      .btn-ghost {
        background: #6c757d;
        color: #fff;
        padding: 0.45rem 0.7rem;
      }

      .btn-ghost:hover {
        background: #5a6268;
      }

      .password-output-group {
        display: flex;
        align-items: center;
        gap: 0.5rem;
      }

      .password-output-group input[type="text"],
      .password-output-group input[type="password"] {
        flex-grow: 1;
      }

      .strength {
        text-align: center;
        margin-top: 0.5rem;
        font-weight: 500;
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
        font-size: 0.9rem;
      }

      .strength-bar {
        height: 10px;
        border-radius: 5px;
        background-color: #ddd;
        overflow: hidden;
      }

      body.dark .strength-bar {
        background-color: #444;
      }

      .strength-indicator {
        height: 100%;
        width: 0%;
        background-color: var(--strength-weak);
        transition: width 0.3s ease-in-out, background-color 0.3s ease-in-out;
      }

      .strength-text {
        color: inherit;
      }

      .error-message {
        color: #e74c3c;
        font-size: 0.85rem;
        text-align: center;
        min-height: 1.2rem;
      }

      .options-inline-note {
        font-size: 0.8rem;
        opacity: 0.8;
      }

      .dashboard-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
        gap: 1rem;
        margin-top: 0.5rem;
      }

      .stat-value {
        font-size: 1.3rem;
        font-weight: 600;
      }

      .stat-label {
        font-size: 0.85rem;
        opacity: 0.8;
      }

      .history-list {
        list-style: none;
        padding-left: 0;
        margin: 0.5rem 0 0;
        font-family: "SF Mono", Menlo, Monaco, Consolas, "Liberation Mono",
          "Courier New", monospace;
        font-size: 0.8rem;
        max-height: 180px;
        overflow-y: auto;
      }

      .history-list li {
        padding: 0.25rem 0;
        border-bottom: 1px dashed rgba(0, 0, 0, 0.08);
        display: flex;
        justify-content: space-between;
        gap: 0.5rem;
        align-items: center;
      }

      body.dark .history-list li {
        border-bottom-color: rgba(255, 255, 255, 0.06);
      }

      .history-password {
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
      }

      .history-meta {
        font-size: 0.75rem;
        opacity: 0.7;
        flex-shrink: 0;
      }

      .help-list {
        font-size: 0.9rem;
        padding-left: 1.2rem;
      }

      .help-list li {
        margin-bottom: 0.4rem;
      }

      footer {
        border-top: 1px solid var(--border-light);
        background-color: var(--footer-bg-light);
        font-size: 0.8rem;
      }

      body.dark footer {
        background-color: var(--footer-bg-dark);
        border-top-color: var(--border-dark);
      }

      .footer-inner {
        max-width: 960px;
        margin: 0 auto;
        padding: 0.75rem 1rem 1rem;
        display: flex;
        justify-content: space-between;
        flex-wrap: wrap;
        gap: 0.5rem;
        opacity: 0.85;
      }

      .footer-inner a {
        color: inherit;
        text-decoration: underline;
        text-decoration-thickness: 0.06em;
        text-underline-offset: 0.15em;
      }

      @media (max-width: 640px) {
        .header-inner {
          flex-direction: column;
          align-items: flex-start;
        }

        nav {
          width: 100%;
          justify-content: space-between;
        }

        .generator-card {
          padding: 1.25rem;
        }
      }
    </style>
  </head>
  <body>
    <div class="app">
      <header>
        <div class="header-inner">
          <div class="brand">
            <div class="brand-title">SecurePass Studio</div>
            <div class="brand-subtitle">
              G√©n√©rateur de mots de passe locaux, sans tracking.
            </div>
          </div>
          <nav>
            <button
              class="nav-link nav-link--active"
              data-section="section-generator"
              aria-current="page">
              G√©n√©rateur
            </button>
            <button
              class="nav-link"
              data-section="section-dashboard">
              Tableau de bord
            </button>
            <button
              class="nav-link"
              data-section="section-help">
              Aide
            </button>
            <button
              id="themeToggle"
              class="theme-toggle-btn"
              type="button">
              Mode sombre
            </button>
          </nav>
        </div>
      </header>

      <main>
        <!-- SECTION GENERATEUR -->
        <section
          id="section-generator"
          class="section section--active">
          <h2 class="section-title">G√©n√©rateur de mot de passe</h2>
          <div class="card generator-card">
            <div class="controls">
              <label>
                Longueur totale :
                <select id="lengthSelect">
                  <option value="8">8 caract√®res</option>
                  <option value="12">12 caract√®res</option>
                  <option value="16" selected>16 caract√®res</option>
                  <option value="20">20 caract√®res</option>
                  <option value="24">24 caract√®res</option>
                  <option value="30">30 caract√®res</option>
                  <option value="40">40 caract√®res</option>
                  <option value="50">50 caract√®res</option>
                </select>
              </label>

              <div class="char-option">
                <label>
                  <input
                    type="checkbox"
                    id="includeLower"
                    checked />
                  Minuscules (a-z)
                </label>
                <div class="min-input-group">
                  <label for="minLower">Min :</label>
                  <input
                    type="number"
                    id="minLower"
                    value="3"
                    min="0"
                    max="50" />
                </div>
              </div>

              <div class="char-option">
                <label>
                  <input
                    type="checkbox"
                    id="includeUpper"
                    checked />
                  Majuscules (A-Z)
                </label>
                <div class="min-input-group">
                  <label for="minUpper">Min :</label>
                  <input
                    type="number"
                    id="minUpper"
                    value="3"
                    min="0"
                    max="50" />
                </div>
              </div>

              <div class="char-option">
                <label>
                  <input
                    type="checkbox"
                    id="includeDigits"
                    checked />
                  Chiffres (0-9)
                </label>
                <div class="min-input-group">
                  <label for="minDigits">Min :</label>
                  <input
                    type="number"
                    id="minDigits"
                    value="3"
                    min="0"
                    max="50" />
                </div>
              </div>

              <div class="char-option">
                <label>
                  <input
                    type="checkbox"
                    id="includeSpecial"
                    checked />
                  Caract√®res sp√©ciaux (%$!@#^&*)
                </label>
                <div class="min-input-group">
                  <label for="minSpecial">Min :</label>
                  <input
                    type="number"
                    id="minSpecial"
                    value="5"
                    min="0"
                    max="50" />
                </div>
              </div>

              <label>
                <input
                  type="checkbox"
                  id="avoidConsecutive"
                  checked />
                Interdire deux caract√®res identiques √† la suite
              </label>

              <p class="options-inline-note">
                Astuce : pour un compte critique, visez au moins 20 caract√®res,
                tous types inclus.
              </p>

              <button
                id="generateBtn"
                class="btn-primary"
                type="button">
                G√©n√©rer
              </button>

              <div
                id="errorMessage"
                class="error-message"></div>

              <div class="password-output-group">
                <input
                  type="text"
                  id="passwordOutput"
                  readonly
                  placeholder="Votre mot de passe" />
                <button
                  id="toggleVisibilityBtn"
                  class="btn-ghost"
                  type="button"
                  title="Afficher/Masquer le mot de passe">
                  üôà
                </button>
              </div>

              <button
                id="copyBtn"
                class="btn-primary"
                type="button">
                Copier üìã
              </button>

              <div
                id="strengthDisplay"
                class="strength">
                <div class="strength-bar">
                  <div
                    id="strengthIndicator"
                    class="strength-indicator"></div>
                </div>
                <div
                  id="strengthText"
                  class="strength-text">
                  Robustesse : Non √©valu√©e
                </div>
              </div>
            </div>
          </div>
        </section>

        <!-- SECTION TABLEAU DE BORD -->
        <section
          id="section-dashboard"
          class="section">
          <h2 class="section-title">Tableau de bord</h2>
          <div class="card">
            <p style="font-size: 0.9rem; margin-top: 0; margin-bottom: 0.75rem">
              Statistiques locales de cette session seulement. Rien n‚Äôest envoy√©
              sur un serveur.
            </p>
            <div class="dashboard-grid">
              <div>
                <div class="stat-value" id="statCount">0</div>
                <div class="stat-label">
                  Mots de passe g√©n√©r√©s (session)
                </div>
              </div>
              <div>
                <div
                  class="stat-value"
                  id="statAvgLength">
                  0
                </div>
                <div class="stat-label">
                  Longueur moyenne
                </div>
              </div>
              <div>
                <div
                  class="stat-value"
                  id="statLastGenerated">
                  ‚Äî
                </div>
                <div class="stat-label">
                  Derni√®re g√©n√©ration
                </div>
              </div>
            </div>

            <h3 style="margin-top: 1.25rem; font-size: 1rem; margin-bottom: 0.35rem">
              Historique des derniers mots de passe
            </h3>
            <p style="margin-top: 0; font-size: 0.8rem; opacity: 0.8">
              Maximum 10 entr√©es, stock√©es uniquement en m√©moire (elles
              dispara√Ætront au rechargement de la page).
            </p>
            <ul
              id="historyList"
              class="history-list"></ul>
          </div>
        </section>

        <!-- SECTION AIDE -->
        <section
          id="section-help"
          class="section">
          <h2 class="section-title">Aide et bonnes pratiques</h2>
          <div class="card">
            <p style="margin-top: 0; font-size: 0.95rem">
              Quelques conseils de base pour utiliser ce g√©n√©rateur de mani√®re
              efficace :
            </p>
            <ul class="help-list">
              <li>
                Utilisez un
                <strong>mot de passe diff√©rent pour chaque service</strong>.
              </li>
              <li>
                Privil√©giez une
                <strong>longueur ‚â• 16‚Äì20 caract√®res</strong> avec tous les
                types activ√©s.
              </li>
              <li>
                Ne stockez jamais vos mots de passe en clair dans un fichier
                texte synchronis√© sans chiffrement.
              </li>
              <li>
                Id√©alement,
                <strong>combinez ce g√©n√©rateur avec un coffre-fort</strong>
                chiffr√© (KeePass, fichiers KDBX, etc.).
              </li>
              <li>
                √âvitez d‚Äôutiliser ce g√©n√©rateur sur une machine que vous ne
                contr√¥lez pas (poste public, PC d‚Äôh√¥tel, etc.).
              </li>
            </ul>
            <p style="font-size: 0.9rem; margin-top: 0.75rem">
              Ce site est purement statique : aucun mot de passe n‚Äôest envoy√©
              sur un serveur. Tout se fait dans votre navigateur.
            </p>
          </div>
        </section>
      </main>

      <footer>
        <div class="footer-inner">
          <span>G√©n√©rateur local ‚Äì sans tracking.</span>
          <span>
            Code h√©berg√© sur GitHub Pages ¬∑ Pensez √† v√©rifier le code source
            avant d‚Äôutiliser en production.
          </span>
        </div>
      </footer>
    </div>

    <script>
      // Centralisation des √©l√©ments DOM
      const DOMElements = {
        lengthSelect: document.getElementById("lengthSelect"),
        includeLower: document.getElementById("includeLower"),
        minLower: document.getElementById("minLower"),
        includeUpper: document.getElementById("includeUpper"),
        minUpper: document.getElementById("minUpper"),
        includeDigits: document.getElementById("includeDigits"),
        minDigits: document.getElementById("minDigits"),
        includeSpecial: document.getElementById("includeSpecial"),
        minSpecial: document.getElementById("minSpecial"),
        generateBtn: document.getElementById("generateBtn"),
        passwordOutput: document.getElementById("passwordOutput"),
        toggleVisibilityBtn: document.getElementById("toggleVisibilityBtn"),
        copyBtn: document.getElementById("copyBtn"),
        strengthText: document.getElementById("strengthText"),
        strengthIndicator: document.getElementById("strengthIndicator"),
        strengthDisplay: document.getElementById("strengthDisplay"),
        themeToggle: document.getElementById("themeToggle"),
        body: document.body,
        errorMessage: document.getElementById("errorMessage"),
        avoidConsecutive: document.getElementById("avoidConsecutive"),
        navLinks: document.querySelectorAll(".nav-link[data-section]"),
        sections: document.querySelectorAll(".section"),
        statCount: document.getElementById("statCount"),
        statAvgLength: document.getElementById("statAvgLength"),
        statLastGenerated: document.getElementById("statLastGenerated"),
        historyList: document.getElementById("historyList"),
      };

      // Jeu de caract√®res de base
      const BASE_CHAR_SETS = {
        lower: "abcdefghijklmnopqrstuvwxyz",
        upper: "ABCDEFGHIJKLMNOPQRSTUVWXYZ",
        digits: "0123456789",
        special: "%$!@#^&*",
      };

      // Statistiques de la session
      const sessionStats = {
        count: 0,
        totalLength: 0,
        lastGeneratedAt: null,
        history: [],
        historyLimit: 10,
      };

      // Utils RNG
      function randIndex(maxExclusive) {
        return crypto.getRandomValues(new Uint32Array(1))[0] % maxExclusive;
      }

      function getRandomCharFromSet(setStr, excludeSet = new Set()) {
        if (!setStr || setStr.length === 0) return "";
        for (let tries = 0; tries < 32; tries++) {
          const c = setStr.charAt(randIndex(setStr.length));
          if (!excludeSet.has(c)) return c;
        }
        for (let i = 0; i < setStr.length; i++) {
          const c = setStr.charAt(i);
          if (!excludeSet.has(c)) return c;
        }
        return "";
      }

      function charTypeOf(ch) {
        if (BASE_CHAR_SETS.lower.includes(ch)) return "lower";
        if (BASE_CHAR_SETS.upper.includes(ch)) return "upper";
        if (BASE_CHAR_SETS.digits.includes(ch)) return "digits";
        if (BASE_CHAR_SETS.special.includes(ch)) return "special";
        return null;
      }

      function countTypes(arr) {
        const map = { lower: 0, upper: 0, digits: 0, special: 0 };
        for (const c of arr) {
          const t = charTypeOf(c);
          if (t) map[t]++;
        }
        return map;
      }

      // Corrige les doublons cons√©cutifs en respectant les min par type
      function enforceNoConsecutiveDuplicates(pwdArray, allCharsPool, minMap) {
        const out = pwdArray.slice();
        const counts = countTypes(out);

        const uniquePool = Array.from(new Set(allCharsPool.split("")));
        if (uniquePool.length <= 1 && out.length > 1) {
          DOMElements.errorMessage.textContent =
            "Impossible d‚Äô√©viter les doublons cons√©cutifs avec un pool d‚Äôun seul caract√®re.";
          return out;
        }

        for (let i = 1; i < out.length; i++) {
          if (out[i] === out[i - 1]) {
            const original = out[i];
            const originalType = charTypeOf(original);
            const exclude = new Set([out[i - 1]]);
            if (i + 1 < out.length) exclude.add(out[i + 1]);

            let replacement = "";
            if (originalType && counts[originalType] <= (minMap[originalType] || 0)) {
              replacement = getRandomCharFromSet(BASE_CHAR_SETS[originalType], exclude);
              if (!replacement) {
                replacement = getRandomCharFromSet(allCharsPool, exclude);
                const newType = charTypeOf(replacement);
                if (newType && newType !== originalType) {
                  counts[originalType] = Math.max(0, counts[originalType] - 1);
                  counts[newType] = (counts[newType] || 0) + 1;
                }
              }
            } else {
              replacement = getRandomCharFromSet(allCharsPool, exclude);
              const newType = charTypeOf(replacement);
              if (originalType && newType && newType !== originalType) {
                counts[originalType] = Math.max(0, counts[originalType] - 1);
                counts[newType] = (counts[newType] || 0) + 1;
              }
            }

            if (!replacement) {
              replacement =
                uniquePool.find((c) => c !== out[i - 1]) ||
                out[i];
            }

            out[i] = replacement;
          }
        }
        return out;
      }

      // G√©n√©ration
      function generatePassword() {
        DOMElements.errorMessage.textContent = "";
        const length = parseInt(DOMElements.lengthSelect.value, 10);
        const avoidConsecutive = DOMElements.avoidConsecutive.checked;

        let characterRequirements = [];
        let totalGuaranteedCount = 0;
        let allCharsPool = "";

        if (DOMElements.includeLower.checked) {
          const count = parseInt(DOMElements.minLower.value, 10) || 0;
          characterRequirements.push({
            type: "lower",
            chars: BASE_CHAR_SETS.lower,
            minCount: count,
          });
          totalGuaranteedCount += count;
          allCharsPool += BASE_CHAR_SETS.lower;
        }
        if (DOMElements.includeUpper.checked) {
          const count = parseInt(DOMElements.minUpper.value, 10) || 0;
          characterRequirements.push({
            type: "upper",
            chars: BASE_CHAR_SETS.upper,
            minCount: count,
          });
          totalGuaranteedCount += count;
          allCharsPool += BASE_CHAR_SETS.upper;
        }
        if (DOMElements.includeDigits.checked) {
          const count = parseInt(DOMElements.minDigits.value, 10) || 0;
          characterRequirements.push({
            type: "digits",
            chars: BASE_CHAR_SETS.digits,
            minCount: count,
          });
          totalGuaranteedCount += count;
          allCharsPool += BASE_CHAR_SETS.digits;
        }
        if (DOMElements.includeSpecial.checked) {
          const count = parseInt(DOMElements.minSpecial.value, 10) || 0;
          characterRequirements.push({
            type: "special",
            chars: BASE_CHAR_SETS.special,
            minCount: count,
          });
          totalGuaranteedCount += count;
          allCharsPool += BASE_CHAR_SETS.special;
        }

        if (characterRequirements.length === 0) {
          DOMElements.errorMessage.textContent =
            "Veuillez s√©lectionner au moins un type de caract√®res.";
          return "";
        }

        if (totalGuaranteedCount > length) {
          DOMElements.errorMessage.textContent = `Le nombre minimum de caract√®res requis (${totalGuaranteedCount}) d√©passe la longueur totale (${length}). Veuillez ajuster.`;
          return "";
        }

        if (allCharsPool.length === 0 && length > 0) {
          DOMElements.errorMessage.textContent =
            "Aucun type de caract√®re n'a √©t√© s√©lectionn√© pour g√©n√©rer le mot de passe.";
          return "";
        }

        let pwdArray = [];

        characterRequirements.forEach((req) => {
          for (let i = 0; i < req.minCount; i++) {
            let c = req.chars.charAt(randIndex(req.chars.length));
            if (avoidConsecutive && pwdArray.length > 0) {
              const exclude = new Set([pwdArray[pwdArray.length - 1]]);
              c = getRandomCharFromSet(req.chars, exclude);
            }
            pwdArray.push(c);
          }
        });

        const remainingLength = length - pwdArray.length;
        for (let i = 0; i < remainingLength; i++) {
          let c = allCharsPool.charAt(randIndex(allCharsPool.length));
          if (avoidConsecutive && pwdArray.length > 0) {
            const exclude = new Set([pwdArray[pwdArray.length - 1]]);
            c = getRandomCharFromSet(allCharsPool, exclude);
          }
          pwdArray.push(c);
        }

        const shuffled = shuffleArray(pwdArray);

        if (avoidConsecutive) {
          const minMap = { lower: 0, upper: 0, digits: 0, special: 0 };
          characterRequirements.forEach((r) => {
            minMap[r.type] = r.minCount;
          });
          const fixed = enforceNoConsecutiveDuplicates(
            shuffled,
            allCharsPool,
            minMap,
          );
          return fixed.join("");
        }

        return shuffled.join("");
      }

      function shuffleArray(arr) {
        const a = arr.slice();
        for (let i = a.length - 1; i > 0; i--) {
          const j = randIndex(i + 1);
          [a[i], a[j]] = [a[j], a[i]];
        }
        return a;
      }

      // √âvaluation de la robustesse
      function evaluateStrength(pwd) {
        if (!pwd) {
          return { text: "Non √©valu√©e", score: 0 };
        }

        let score = 0;
        const length = pwd.length;

        score += Math.log2(length) * 5;

        let typesCount = 0;
        if (/[a-z]/.test(pwd)) typesCount++;
        if (/[A-Z]/.test(pwd)) typesCount++;
        if (/[0-9]/.test(pwd)) typesCount++;
        if (/[%\$!@#\^&\*]/.test(pwd)) typesCount++;

        score += typesCount * 10;

        score += (pwd.match(/[a-z]/g) || []).length * 0.5;
        score += (pwd.match(/[A-Z]/g) || []).length * 0.7;
        score += (pwd.match(/[0-9]/g) || []).length * 0.6;
        score += (pwd.match(/[%\$!@#\^&\*]/g) || []).length * 0.8;

        const maxScore = 100;
        score = Math.max(0, Math.min(score, maxScore));

        let strengthText = "";
        const strengthLevel = score / maxScore;

        if (strengthLevel < 0.25) {
          strengthText = "Faible";
          DOMElements.strengthIndicator.style.backgroundColor =
            "var(--strength-weak)";
        } else if (strengthLevel < 0.5) {
          strengthText = "Moyen";
          DOMElements.strengthIndicator.style.backgroundColor =
            "var(--strength-medium)";
        } else if (strengthLevel < 0.75) {
          strengthText = "Fort";
          DOMElements.strengthIndicator.style.backgroundColor =
            "var(--strength-strong)";
        } else {
          strengthText = "Tr√®s fort";
          DOMElements.strengthIndicator.style.backgroundColor =
            "var(--strength-very-strong)";
        }

        DOMElements.strengthIndicator.style.width = `${strengthLevel * 100}%`;
        return { text: strengthText, score: strengthLevel };
      }

      function updateStrengthDisplay(pwd = DOMElements.passwordOutput.value) {
        const { text } = evaluateStrength(pwd);
        DOMElements.strengthText.textContent = `Robustesse : ${text}`;
      }

      // Limites dynamiques min/max
      function adjustMinMaxLimits() {
        const totalLength = parseInt(DOMElements.lengthSelect.value, 10);
        let currentMins = 0;

        const charTypes = ["lower", "upper", "digits", "special"];
        const charMins = {};

        charTypes.forEach((type) => {
          const checkbox =
            DOMElements[
              `include${type.charAt(0).toUpperCase()}${type.slice(1)}`
            ];
          const minInput =
            DOMElements[
              `min${type.charAt(0).toUpperCase()}${type.slice(1)}`
            ];
          charMins[type] = parseInt(minInput.value, 10) || 0;
          if (checkbox.checked) {
            currentMins += charMins[type];
          }
        });

        charTypes.forEach((type) => {
          const minInput =
            DOMElements[
              `min${type.charAt(0).toUpperCase()}${type.slice(1)}`
            ];
          const checkbox =
            DOMElements[
              `include${type.charAt(0).toUpperCase()}${type.slice(1)}`
            ];
          const otherMins = currentMins - charMins[type];
          const newMax = checkbox.checked
            ? Math.max(0, totalLength - otherMins)
            : 0;
          minInput.max = newMax;
          if (parseInt(minInput.value, 10) > newMax) {
            minInput.value = newMax;
          }
        });
      }

      // Stats + dashboard
      function updateSessionStats(newPassword) {
        if (!newPassword) return;
        const length = newPassword.length;

        sessionStats.count += 1;
        sessionStats.totalLength += length;
        sessionStats.lastGeneratedAt = new Date();

        sessionStats.history.unshift({
          password: newPassword,
          length,
          at: sessionStats.lastGeneratedAt,
        });

        if (sessionStats.history.length > sessionStats.historyLimit) {
          sessionStats.history.length = sessionStats.historyLimit;
        }

        renderDashboard();
      }

      function renderDashboard() {
        DOMElements.statCount.textContent = sessionStats.count.toString();

        if (sessionStats.count === 0) {
          DOMElements.statAvgLength.textContent = "0";
          DOMElements.statLastGenerated.textContent = "‚Äî";
        } else {
          const avg =
            sessionStats.totalLength / sessionStats.count;
          DOMElements.statAvgLength.textContent =
            avg.toFixed(1);
          const d = sessionStats.lastGeneratedAt;
          const h = String(d.getHours()).padStart(2, "0");
          const m = String(d.getMinutes()).padStart(2, "0");
          DOMElements.statLastGenerated.textContent = `${h}h${m}`;
        }

        DOMElements.historyList.innerHTML = "";
        sessionStats.history.forEach((item) => {
          const li = document.createElement("li");
          const pwdSpan = document.createElement("span");
          pwdSpan.className = "history-password";
          pwdSpan.textContent = item.password;

          const metaSpan = document.createElement("span");
          metaSpan.className = "history-meta";
          const d = item.at;
          const h = String(d.getHours()).padStart(2, "0");
          const m = String(d.getMinutes()).padStart(2, "0");
          metaSpan.textContent = `${item.length}c ¬∑ ${h}h${m}`;

          li.appendChild(pwdSpan);
          li.appendChild(metaSpan);

          DOMElements.historyList.appendChild(li);
        });
      }

      // Navigation mono-page
      function setActiveSection(sectionId) {
        DOMElements.sections.forEach((section) => {
          const isActive = section.id === sectionId;
          section.classList.toggle("section--active", isActive);
        });

        DOMElements.navLinks.forEach((link) => {
          const isActive = link.dataset.section === sectionId;
          link.classList.toggle("nav-link--active", isActive);
          if (isActive) {
            link.setAttribute("aria-current", "page");
          } else {
            link.removeAttribute("aria-current");
          }
        });
      }

      DOMElements.navLinks.forEach((link) => {
        link.addEventListener("click", (event) => {
          event.preventDefault();
          const target = link.dataset.section;
          if (target) {
            setActiveSection(target);
          }
        });
      });

      // Th√®me persistant
      function applyThemeFromStorage() {
        const storedTheme = localStorage.getItem("pwgen-theme");
        if (storedTheme === "dark") {
          DOMElements.body.classList.add("dark");
          DOMElements.themeToggle.textContent = "Mode clair";
        } else {
          DOMElements.body.classList.remove("dark");
          DOMElements.themeToggle.textContent = "Mode sombre";
        }
      }

      DOMElements.themeToggle.addEventListener("click", () => {
        DOMElements.body.classList.toggle("dark");
        const isDark = DOMElements.body.classList.contains("dark");
        localStorage.setItem("pwgen-theme", isDark ? "dark" : "light");
        DOMElements.themeToggle.textContent = isDark
          ? "Mode clair"
          : "Mode sombre";
      });

      // Gestionnaires d‚Äô√©v√©nements principaux
      DOMElements.generateBtn.addEventListener("click", () => {
        const pwd = generatePassword();
        DOMElements.passwordOutput.value = pwd;
        DOMElements.toggleVisibilityBtn.textContent = "üôà";
        updateStrengthDisplay(pwd);
        updateSessionStats(pwd);
        DOMElements.passwordOutput.focus();
      });

      DOMElements.copyBtn.addEventListener("click", () => {
        const pwd = DOMElements.passwordOutput.value;
        if (!pwd) return;
        navigator.clipboard
          .writeText(pwd)
          .then(() => {
            DOMElements.copyBtn.textContent = "Copi√© !";
            setTimeout(() => {
              DOMElements.copyBtn.textContent = "Copier üìã";
            }, 1500);
          })
          .catch(() => {
            DOMElements.errorMessage.textContent =
              "√âchec de la copie. Veuillez copier manuellement.";
            setTimeout(() => {
              DOMElements.errorMessage.textContent = "";
            }, 3000);
          });
      });

      DOMElements.toggleVisibilityBtn.addEventListener("click", () => {
        const currentType = DOMElements.passwordOutput.type;
        if (currentType === "password") {
          DOMElements.passwordOutput.type = "text";
          DOMElements.toggleVisibilityBtn.textContent = "üôà";
        } else {
          DOMElements.passwordOutput.type = "password";
          DOMElements.toggleVisibilityBtn.textContent = "üëÅÔ∏è";
        }
      });

      DOMElements.avoidConsecutive.addEventListener("change", () => {
        adjustMinMaxLimits();
        updateStrengthDisplay();
        DOMElements.generateBtn.click();
      });

      const charOptionInputs = [
        { checkbox: DOMElements.includeLower, number: DOMElements.minLower },
        { checkbox: DOMElements.includeUpper, number: DOMElements.minUpper },
        { checkbox: DOMElements.includeDigits, number: DOMElements.minDigits },
        {
          checkbox: DOMElements.includeSpecial,
          number: DOMElements.minSpecial,
        },
      ];

      charOptionInputs.forEach((item) => {
        item.number.disabled = !item.checkbox.checked;

        item.checkbox.addEventListener("change", () => {
          item.number.disabled = !item.checkbox.checked;
          if (!item.checkbox.checked) {
            item.number.value = "0";
          } else if (
            parseInt(item.number.value, 10) === 0 ||
            item.number.value === ""
          ) {
            item.number.value = "1";
          }
          adjustMinMaxLimits();
          updateStrengthDisplay();
          DOMElements.generateBtn.click();
        });

        item.number.addEventListener("input", () => {
          if (parseInt(item.number.value, 10) === 0) {
            item.checkbox.checked = false;
            item.number.disabled = true;
          } else {
            item.checkbox.checked = true;
            item.number.disabled = false;
          }
          adjustMinMaxLimits();
          updateStrengthDisplay();
          DOMElements.generateBtn.click();
        });
      });

      DOMElements.lengthSelect.addEventListener("change", () => {
        adjustMinMaxLimits();
        updateStrengthDisplay();
        DOMElements.generateBtn.click();
      });

      // Initialisation
      window.addEventListener("load", () => {
        applyThemeFromStorage();

        charOptionInputs.forEach((item) => {
          item.number.disabled = !item.checkbox.checked;
        });

        DOMElements.includeLower.checked = true;
        DOMElements.includeUpper.checked = true;
        DOMElements.includeDigits.checked = true;
        DOMElements.includeSpecial.checked = true;
        DOMElements.minLower.value = "3";
        DOMElements.minUpper.value = "3";
        DOMElements.minDigits.value = "3";
        DOMElements.minSpecial.value = "5";
        DOMElements.lengthSelect.value = "20";

        DOMElements.passwordOutput.type = "text";
        DOMElements.toggleVisibilityBtn.textContent = "üôà";

        adjustMinMaxLimits();
        renderDashboard();
        DOMElements.generateBtn.click();
      });
    </script>
  </body>
</html>
